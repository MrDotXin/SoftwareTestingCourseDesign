# 电梯实时监测系统

## 系统概述

电梯实时监测系统是PropSmart物业管理平台的一个重要组成部分，用于实时监控电梯运行状态，及时发现并处理异常情况，确保电梯安全运行。系统采用模块化设计，将业务逻辑与数据模拟分离，提高系统的可维护性和扩展性。

## 主要功能

1. **电梯实时数据监测**
   - 实时采集电梯运行参数（楼层、方向、速度、温度等）
   - 数据可视化展示
   - 异常情况自动预警
   - 与所属楼栋关联，确保楼层范围合理

2. **电梯异常处理**
   - 异常记录与分类（轻微、中等、严重三级）
   - 异常处理流程管理（待处理、处理中、已解决、已关闭）
   - 处理结果追踪
   - 异常状态统计与分析

3. **电梯维护管理**
   - 电梯维护记录
   - 维护提醒
   - 维护后状态恢复
   - 自动处理相关异常记录

4. **电梯配置管理**
   - 电梯运行参数阈值配置（最大速度、温度、功耗等）
   - 预警规则设置
   - 维护间隔设置

## 优化的数据模拟与维护流程

系统对电梯数据模拟和维护流程进行了优化：

1. **基于状态的数据模拟**
   - 故障和维护中的电梯将停止数据模拟
   - 只有解决了严重异常的电梯才能恢复正常运行
   - 电梯状态变化会记录在日志中并通过WebSocket实时通知相关用户

2. **自动异常处理**
   - 当电梯进行维护后，系统会自动将未解决的异常标记为已解决
   - 系统自动记录维护历史和解决的异常数量
   - 维护后电梯自动恢复为正常状态

3. **异常级别响应**
   - 严重异常：电梯立即停止运行，需要维修，状态变为故障（FAULT）
   - 中等异常：电梯进入预警状态（WARNING），但可以继续运行
   - 轻微异常：记录异常，不影响正常运行（NORMAL）

4. **智能电梯运行模拟**
   - 根据电梯当前楼层、楼栋总层数和运行方向智能调整运动
   - 考虑物理约束（不超过顶层、不低于底层）
   - 模拟电梯实际运行特性，包括静止、上行、下行三种状态
   - 根据运行状态动态调整参数（速度、加速度、门状态、温度等）

## 用户权限

- **普通用户**：只能查看电梯基本信息（电梯ID、编号、安装日期、维护时间、当前状态）
- **管理员**：可查看全部信息，处理异常，进行维护，修改配置

## 数据模拟器

系统内置电梯数据模拟器，用于模拟电梯传感器实时数据：

- 自动生成电梯运行数据（位置、速度、温度等）
- 考虑电梯实际运行规律，模拟更真实的运行状态
- 随机模拟异常情况（概率可配置）
- 根据配置的阈值自动判断是否异常
- 异常情况自动记录并改变电梯状态
- 根据电梯状态决定是否继续产生数据
- 模拟器与业务逻辑解耦，放置在job层，便于维护和扩展

## 系统设计亮点

1. **模块化设计**
   - 服务层（Service）：处理业务逻辑
   - 作业层（Job）：处理数据模拟和定时任务
   - 控制层（Controller）：提供API接口
   - 数据层（Mapper）：处理数据库操作

2. **性能优化**
   - 缓存楼栋总层数数据，减少数据库查询
   - 批量处理异常记录
   - 避免不必要的数据库操作

3. **智能模拟**
   - 模拟电梯物理特性，如加速度、速度变化
   - 考虑运行方向与门状态的关系
   - 模拟电机温度与运动状态的关联
   - 模拟功耗与运动状态和负载的关系

4. **实时通知**
   - 通过WebSocket通知电梯状态变化
   - 针对不同用户角色推送不同级别的消息

## API接口

### 电梯基本信息

- `GET /elevator/list/basic` - 获取所有电梯基本信息（用户视图）
- `GET /elevator/basic/{id}` - 获取指定电梯基本信息（用户视图）
- `GET /elevator/list/detail` - 获取所有电梯详细信息（管理员视图）
- `GET /elevator/detail/{id}` - 获取指定电梯详细信息（管理员视图）

### 电梯维护

- `POST /elevator/maintenance/{id}` - 更新电梯维护日期（管理员操作）
- `GET /elevator/maintenance/needed` - 获取所有需要维护的电梯（管理员视图）

### 电梯配置

- `GET /elevator/config/{id}` - 获取电梯配置信息（管理员视图）
- `POST /elevator/config/update` - 更新电梯配置（管理员操作）

### 电梯异常管理

- `GET /elevator/abnormality/list` - 获取所有电梯异常记录（管理员视图）
- `GET /elevator/abnormality/list/{elevatorId}` - 获取指定电梯的异常记录（管理员视图）
- `POST /elevator/abnormality/handle/{id}` - 处理电梯异常（管理员操作）
- `POST /elevator/abnormality/close/{id}` - 关闭电梯异常（管理员操作）
- `GET /elevator/abnormality/unresolved` - 获取所有未解决的电梯异常（管理员视图）
- `GET /elevator/abnormality/stats` - 获取电梯异常统计数据（管理员视图）

### 数据模拟器控制

- `POST /elevator/simulator/start` - 启动电梯数据模拟器（管理员操作）
- `POST /elevator/simulator/stop` - 停止电梯数据模拟器（管理员操作）

## 技术架构

- **后端**: Spring Boot + MyBatis-Plus
- **数据库**: MySQL
- **实时数据模拟**: 定时任务 + 随机数据生成
- **异常处理**: 事件驱动 + 状态机
- **实时通知**: WebSocket

## 异常类型与详细说明

1. **电机温度异常 (MOTOR_OVERHEATING)**
   - 严重异常：电机温度超过配置的最大阈值，电梯状态变为故障
   - 中等异常：电机温度接近配置的最大阈值（90%以上），电梯状态变为预警

2. **轿厢温度异常 (CABIN_OVERHEATING)**
   - 中等异常：轿厢温度超过配置的最大阈值，电梯状态变为预警

3. **超速异常 (OVERSPEED)**
   - 严重异常：电梯运行速度超过配置的最大速度，电梯状态变为故障

4. **功耗异常 (POWER_ANOMALY)**
   - 中等异常：电梯功耗超过配置的最大功耗，电梯状态变为预警

5. **其他异常类型**
   - 门故障 (DOOR_FAULT)
   - 超载 (OVERLOAD)
   - 制动系统故障 (BRAKE_FAILURE)
   - 传感器故障 (SENSOR_FAILURE)

## 电梯状态处理流程

1. **正常状态 (NORMAL)**
   - 电梯正常运行，数据模拟器持续模拟数据
   - 无异常或只有轻微异常

2. **预警状态 (WARNING)**
   - 电梯有中等异常，但仍可继续运行
   - 数据模拟器继续模拟数据
   - 需要管理员关注并处理

3. **故障状态 (FAULT)**
   - 电梯有严重异常，停止运行
   - 数据模拟器停止为该电梯模拟数据
   - 需要立即处理并维护

4. **维护状态 (MAINTENANCE)**
   - 电梯正在进行维护
   - 数据模拟器停止为该电梯模拟数据
   - 维护完成后自动将状态恢复为正常，并解决相关异常 